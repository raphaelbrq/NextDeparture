<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Prochains départs</title>
</head>

<body>
    <h1>Prochains départs</h1>

    <label>
        Station :
        <input type="text" id="stationInput" value="Lausanne">
    </label>
    <button onclick="loadDepartures()">Rechercher</button>
    <label>
        Nb résultats :
        <input type="int" id="lengthInput" value="15">
    </label>

    <ul id="results"></ul>

    <script>
        function loadDepartures() {
            const station = document.getElementById('stationInput').value;
            const lengthLimit = document.getElementById('lengthInput').value;
            const url = `https://transport.opendata.ch/v1/stationboard?station=${encodeURIComponent(station)}&limit=${encodeURIComponent(lengthLimit)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('results');
                    list.innerHTML = "";

                    if (!data.stationboard || data.stationboard.length === 0) {
                        list.innerHTML = "<li>Aucun départ trouvé.</li>";
                        return;
                    }

                    data.stationboard.forEach(item => {
                        const li = document.createElement("li");
                        const lineNumber = item.number || "—";
                        const lineCategory = item.category || "—";
                        const departureTime = new Date(item.stop.departure)
                            .toLocaleTimeString('fr-CH', { hour: '2-digit', minute: '2-digit' });
                        const delayMinutes = item.stop.delay;
                        const delayText = delayMinutes > 0
                            ? ` +${delayMinutes}'`
                            : "    ";
                        li.textContent = `${departureTime}${delayText} –  ${lineCategory}${lineNumber} → ${item.to} `;
                        list.appendChild(li);
                    });
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('results').innerHTML =
                        "<li>Erreur lors du chargement.</li>";
                });
        }
        loadDepartures();
        setInterval(loadDepartures, 30000);
    </script>
</body>

</html>